<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MMS - ${documentTitle}</title>
    <link rel="stylesheet" href="/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <script>
      // Common utility functions
      const API_BASE = '../backend/api'

      function showToast(msg, ok = true) {
        let el = document.getElementById('toast')
        if (!el) {
          el = document.createElement('div')
          el.id = 'toast'
          el.className = 'toast'
          document.body.appendChild(el)
        }
        el.className = `toast ${ok ? 'success' : 'error'} show`
        el.textContent = msg
        setTimeout(() => {
          el.className = el.className.replace('show', '')
        }, 2500)
      }

      function token() {
        return localStorage.getItem('token')
      }

      function authHeaders() {
        return {
          Authorization: `Bearer ${token()}`,
          'Content-Type': 'application/json',
        }
      }

      async function getJson(path) {
        const res = await fetch(`${API_BASE}${path}`, {
          headers: authHeaders(),
        })
        const data = await res.json().catch(() => ({}))
        if (!res.ok) throw data
        return data
      }

      async function postJson(path, body) {
        const res = await fetch(`${API_BASE}${path}`, {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify(body),
        })
        const data = await res.json().catch(() => ({}))
        if (!res.ok) throw data
        return data
      }

      function toggleSpinner(btn, show) {
        if (show) {
          btn.disabled = true
          btn.innerHTML = '<span class="spinner"></span> Loading...'
        } else {
          btn.disabled = false
          btn.innerHTML = btn.dataset.originalText
        }
      }

      // Navigation
      function switchTab(sectionId) {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach((section) => {
          section.style.display = 'none'
        })

        // Show the selected section
        const activeSection = document.getElementById(sectionId)
        if (activeSection) {
          activeSection.style.display = 'block'
        }

        // Update active link in sidebar
        document.querySelectorAll('.sidebar a').forEach((link) => {
          link.classList.remove('active')
          if (link.getAttribute('href') === `#${sectionId}`) {
            link.classList.add('active')
          }
        })
      }

      // Toggle submenu
      function toggleSubmenu(submenuToggle) {
        const parent = submenuToggle.closest('.has-submenu')
        const isActive = parent.classList.contains('active')

        // Close all other open submenus
        document.querySelectorAll('.has-submenu').forEach((item) => {
          if (item !== parent) {
            item.classList.remove('active')
          }
        })

        // Toggle current submenu
        if (!isActive) {
          parent.classList.add('active')
        } else {
          parent.classList.remove('active')
        }
      }

      // Initialize the page
      document.addEventListener('DOMContentLoaded', function () {
        // Initialize sidebar component
        const sidebarContainer = document.getElementById('sidebar-container')
        if (sidebarContainer) {
          window.sidebarComponent = new SidebarComponent(sidebarContainer)
        }

        // Handle section changes - load components dynamically
        document.addEventListener('sectionChanged', (e) => {
          const sectionId = e.detail.sectionId
          loadComponent(sectionId)
        })

        // Function to load components dynamically
        async function loadComponent(sectionId) {
          const contentArea = document.getElementById('main-content-area')
          if (!contentArea) return

          try {
            // Map section IDs to component files
            const componentMap = {
              dashboard: '/js/components/DashboardComponent.js',
              companies: '/js/components/CompanyComponent.js',
              'companies-add': '/js/components/CompanyComponent.js',
              'companies-active': '/js/components/CompanyComponent.js',
              'companies-inactive': '/js/components/CompanyComponent.js',
              users: '/js/components/UserComponent.js',
              assets: '/js/components/AssetComponent.js',
              reports: '/js/components/ReportsComponent.js',
              settings: '/js/components/SettingsComponent.js',
            }

            const componentPath = componentMap[sectionId]
            if (!componentPath) {
              contentArea.innerHTML = `<div class="error">Component not found for section: ${sectionId}</div>`
              return
            }

            // Load the component script if not already loaded
            if (!window[sectionId + 'Component']) {
              await loadScript(componentPath)
            }

            // Clear existing content
            contentArea.innerHTML = ''

            // Initialize the component
            const ComponentClass =
              window[
                sectionId.charAt(0).toUpperCase() +
                  sectionId.slice(1) +
                  'Component'
              ]
            if (ComponentClass) {
              window[sectionId + 'Component'] = new ComponentClass(contentArea)
            } else {
              contentArea.innerHTML = `<div class="error">Failed to load component: ${sectionId}</div>`
            }
          } catch (error) {
            console.error('Error loading component:', error)
            contentArea.innerHTML = `<div class="error">Error loading component: ${error.message}</div>`
          }
        }

        // Helper function to load scripts dynamically
        function loadScript(src) {
          return new Promise((resolve, reject) => {
            const script = document.createElement('script')
            script.src = src
            script.onload = resolve
            script.onerror = reject
            document.head.appendChild(script)
          })
        }

        // Handle browser back/forward
        window.addEventListener('popstate', () => {
          const sectionId = window.location.hash.substring(1) || 'dashboard'
          if (window.sidebarComponent) {
            window.sidebarComponent.switchToSection(sectionId)
          }
        })

        // Show initial section based on URL hash or default to dashboard
        const initialSection = window.location.hash.substring(1) || 'dashboard'
        loadComponent(initialSection)
      })
    </script>
    <style>
      /* Submenu styles */
      .has-submenu {
        position: relative;
      }

      .submenu-toggle {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }

      .submenu-arrow {
        transition: transform 0.3s ease;
        font-size: 0.8em;
        margin-left: auto;
        padding-left: 10px;
      }

      .has-submenu.active .submenu-arrow {
        transform: rotate(180deg);
      }

      .submenu {
        max-height: 0;
        overflow: hidden;
        padding-left: 1.5rem;
        transition: max-height 0.3s ease, opacity 0.3s ease;
        opacity: 0;
      }

      .has-submenu.active .submenu {
        max-height: 500px;
        opacity: 1;
      }

      .submenu li a {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        color: #9ca3af;
        text-decoration: none;
        transition: all 0.2s;
        font-size: 0.9em;
      }

      .submenu li a:hover,
      .submenu li a.active {
        color: #fff;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 0.25rem;
      }

      .submenu li a i {
        margin-right: 0.5rem;
        width: 1.25rem;
        text-align: center;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .submenu {
          padding-left: 1rem;
        }

        .sidebar-collapsed .submenu {
          display: none;
        }

        .sidebar-collapsed .has-submenu.active .submenu {
          display: block;
          padding-left: 0.5rem;
        }
      }
    </style>
    ${additionalHead || ''}
  </head>
  <body>
    <div class="dashboard-container">
      <aside class="sidebar" id="sidebar-container">
        <!-- Sidebar content will be rendered here by JavaScript -->
      </aside>

      <main class="main-content">
        <header class="main-header">
          <div class="header-title">
            <button class="menu-toggle" id="sidebarToggle">
              <i class="fas fa-bars"></i>
            </button>
            <h1>${pageTitle || 'Dashboard'}</h1>
          </div>
          <div class="user-menu">
            <span class="user-greeting"
              >Welcome, <span id="userName">User</span></span
            >
            <div class="user-avatar">
              <i class="fas fa-user-circle"></i>
            </div>
          </div>
        </header>

        <div id="main-content-area" class="content-wrapper">
          <!-- Dynamic content will be loaded here -->
        </div>
      </main>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast"></div>

    <!-- Scripts -->
    <script src="/js/components/SidebarComponent.js"></script>
    <script src="/js/components/DashboardComponent.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Toggle sidebar on mobile
      document
        .getElementById('sidebarToggle')
        .addEventListener('click', function () {
          document
            .querySelector('.dashboard-container')
            .classList.toggle('sidebar-collapsed')
        })

      // Logout functionality
      document.getElementById('logout').addEventListener('click', function (e) {
        e.preventDefault()
        localStorage.removeItem('token')
        window.location.href = '/index.html'
      })

      // Load user info
      async function loadUserInfo() {
        try {
          const user = await getJson('/users/me')
          if (user && user.name) {
            document.getElementById('userName').textContent = user.name
          }
        } catch (error) {
          console.error('Failed to load user info:', error)
        }
      }

      // Initialize user info
      if (token()) {
        loadUserInfo()
      } else {
        // Redirect to login if not authenticated
        window.location.href = '/index.html'
      }
    </script>
    ${additionalScripts || ''}
  </body>
</html>
